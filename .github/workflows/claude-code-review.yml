name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ${{ github.event.action == 'synchronize' && 'INCREMENTAL REVIEW — this is a follow-up push after a previous review.

            Steps:
            1. Read the PREVIOUS review comments on this PR using `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews`
            2. Review ONLY the new commits since the last review: `git log --oneline origin/${{ github.event.pull_request.base.ref }}..HEAD`
            3. Verify previously reported blockers are resolved
            4. Check that fixes did not introduce new violations
            5. Do NOT re-check all ACs — only verify blocker resolution + new code

            Post findings as a PR review:
            - **APPROVED** if all previous blockers are resolved and no new issues
            - **BLOCKERS** if previous issues persist or new violations found
            - **NOTES** for non-blocking observations'
            || 'Review this PR against the project'\''s architecture principles and spec.

            Steps:
            1. Read `.claude/skills/architecture-principles/reference.md` for the full principles (S1-S7, F1-F2, A1-A14).
            2. Extract the SPEC number from the branch name (e.g. `feat/SPEC-015-*` → SPEC-015). If a matching spec exists in `docs/sdlc/specs/`, read it and check that all Acceptance Criteria are implemented.
            3. Review the PR diff for violations.

            Check for:
            - **Spec compliance**: every AC in the spec is addressed (if a spec exists)
            - **A1**: No business logic or DB queries in routers
            - **A8**: New tables have RLS enabled and `is_record_owner()` policy
            - **A9**: No `agent_name TEXT` — use UUID FK references
            - **A6**: New agent capabilities use `BaseTool` subclass + `agent_tools` DB row
            - **A10**: File naming follows `entity_service.py`, `entity_router.py`, `useEntityHooks.ts`
            - **S1**: New service/tool files have corresponding test files
            - **A3**: User CRUD uses Supabase client (not raw psycopg); framework ops use pg connection
            - **A5**: Frontend hooks use `supabase.auth.getSession()`, not Zustand store

            Post your findings as a PR review comment using `gh pr review` with:
            - **APPROVED** if no issues found
            - **BLOCKERS** listing each violation with its principle ID (e.g. `A8: reminders table missing RLS`)
            - **NOTES** for non-blocking observations' }}
